function changePage(){var a=window.location.hash.replace("#","");a=a.split("&");if(a[0]=="details"){$("#wst-page1").addClass("wst-page1");$("#wst-page2").show();$("#wst-footer").hide();var b=a[1].split("@@");getOrderDetails(b[0],b[1])}else{if(a[0]=="appraises"){$("#wst-page1").addClass("wst-page1");$("#wst-page2").show();$("#wst-footer").hide();var b=a[1].split("@@");getOrderAppraises(b[0],b[1])}else{$("#wst-page1").show();$("#wst-page2").addClass("wst-page2");setTimeout(function(){$("body").removeClass("ajaxpage-active")},100);setTimeout(function(){$("#wst-page1").removeClass("wst-page1");$("#wst-footer").show();$("#wst-page2").css("display","none")},500)}}}var orderIdForCancel;var orderStatusForCancel;var orderIdForComfirm;var cancelOrReject;function getOrderDetails(a,b){$("#wst-default-loading").modal();$.post(WST.U("WebApp/Orders/getOrderDetails"),{orderId:a,shopId:b},function(c){var f=WST.toJson(c);var g=Handlebars.compile($("#orderDetails").text());Handlebars.registerHelper("compare",function(i,j,h){if(i==j){return h.fn(this)}else{return h.inverse(this)}});var e={info:f,rooturl:WST.ROOT};var d=g(e);$("#wst-page2").html(d);$("#wst-default-loading").modal("close");$("body").addClass("ajaxpage-active");setTimeout(function(){$("#wst-page1").hide();$("#wst-page2").removeClass("wst-page2");$(document).scrollTop(0)},300);f=g=f=d=null})}function confirmCancelOrder(a,b){orderIdForCancel=a;orderStatusForCancel=b;wstConfirm("确定取消该订单吗？",toCancelOrder)}function toCancelOrder(){var b={};if(orderStatusForCancel==-2||orderStatusForCancel==0){cancelOrder(orderIdForCancel)}else{if(orderStatusForCancel==1||orderStatusForCancel==2){cancelOrReject="cancel";var a={closeViaDimmer:false};$("#wst-rejectionRemarks-popup").modal(a)}}}function rejectionRemarks(){var a=$("#rejectionRemarks").val();if(a==""){wstMsg("原因不能为空","rejectionRemarks");return false}$("#wst-rejectionRemarks-popup").modal("close");if(cancelOrReject=="cancel"){cancelOrder(orderIdForCancel,a)}else{if(cancelOrReject=="reject"){comfirmOrder(orderIdForComfirm,2)}}}function closePopup(){$("#wst-rejectionRemarks-popup").modal("close")}function cancelOrder(a,c){var b={};b.orderId=a;if(c){b.rejectionRemarks=c}$.post(WST.U("WebApp/Orders/cancelOrder"),b,function(d){var e=WST.toJson(d);if(e.status!=-1){var f=$("#status").val();if(f==0){wstMsg("订单取消成功");setTimeout(function(){location.href=WST.U("WebApp/Orders/index")},2000)}else{setTimeout(function(){$("#order"+orderIdForCancel).addClass("am-animation-slide-top am-animation-reverse");setTimeout(function(){wstMsg("订单取消成功");$("#order"+orderIdForCancel).remove()},500)},500)}}else{wstMsg("订单取消失败，请重试！")}})}function toConfirmOrder(a,b){orderIdForComfirm=a;if(b=="receipt"){wstConfirm("确认收货？",receiptOrder)}else{if(b=="reject"){wstConfirm("确定拒收？",rejectOrder)}}}function receiptOrder(){comfirmOrder(orderIdForComfirm,1)}function rejectOrder(){cancelOrReject="reject";var a={closeViaDimmer:false};$("#wst-rejectionRemarks-popup").modal(a)}function comfirmOrder(a,d){var b={};b.orderId=a;if(d==1){b.type=1}else{if(d==2){var c=$("#rejectionRemarks").val();if(c){b.rejectionRemarks=c}}}$.post(WST.U("WebApp/Orders/confirmOrder"),b,function(e){var f=WST.toJson(e);if(f.status==1){if(d==1){var h="已确认收货"}else{if(d==2){var h="已拒收"}}var g=$("#status").val();if(g==0){wstMsg(h);setTimeout(function(){location.href=WST.U("WebApp/Orders/index")},2000)}else{setTimeout(function(){$("#order"+orderIdForComfirm).addClass("am-animation-slide-top am-animation-reverse");setTimeout(function(){wstMsg(h);$("#order"+orderIdForComfirm).remove()},500)},500)}}else{wstMsg("操作失败，请重试！")}})}function toPay(a){location.href=WST.U("WebApp/Payments/toPay","orderId="+a)}function getOrderAppraises(a){$("#wst-default-loading").modal();$("#orderId").val(a);$.post(WST.U("WebApp/Orders/getNoAppraiseOrderGoods"),{orderId:a},function(b){var e=WST.toJson(b);var f=Handlebars.compile($("#order-appraises").text());Handlebars.registerHelper("goodsIndex",function(g,h){return parseInt(g)+1});Handlebars.registerHelper("compare",function(h,i,g){if(h==i){return g.fn(this)}else{return g.inverse(this)}});var c={info:e,rooturl:WST.ROOT};var d=f(c);$("#wst-page2").html(d);$("#wst-default-loading").modal("close");$("body").addClass("ajaxpage-active");setTimeout(function(){$("#wst-page1").hide();$("#wst-page2").removeClass("wst-page2");$(document).scrollTop(0)},300);f=d=null})}function clickStar(d,b){if(d==0){var c="goods"}else{if(d==1){var c="time"}else{var c="service"}}$("#"+c+"Score").val(b+1);for(var a=0;a<5;a++){if(a<=b){$("."+c+"-appraises").children("img.star").eq(a).attr("src",WST.ROOT+"/Apps/WebApp/View/default/images/1star.png")}else{$("."+c+"-appraises").children("img.star").eq(a).attr("src",WST.ROOT+"/Apps/WebApp/View/default/images/gray_star.png")}}$("."+c+"-tips"+b).show().siblings("span.appraises-tips").hide()}function submitAppraises(){var f=$("#orderId").val();var c=$("#goodsId").val();var b=$("#goodsAttrId").val();var d=$("#goodsName").html();var e=$("#goodsScore").val();var i=$("#timeScore").val();var h=$("#serviceScore").val();var a=$("#appraises").val();if(e==""){wstMsg("请选择商品评分");return false}if(i==""){wstMsg("请选择时效评分");return false}if(h==""){wstMsg("请选择服务评分");return false}if(a.length<3||a.length>50){wstMsg("点评内容为3-50个字");$("#appraises").focus();return false}var g={};g.orderId=f;g.goodsId=c;g.goodsAttrId=b;g.goodsScore=e;g.timeScore=i;g.serviceScore=h;g.content=a;$.post(WST.U("WebApp/Goods/addAppraises"),g,function(j){var l=WST.toJson(j);if(l.status==1){var k='已评价<button type="button" class="am-btn am-btn-default am-btn-xs am-radius isappraises" onclick="scrollToAppraises('+l.id+",'"+d+"',1);\">查看评价</button>";$("#isAppraises"+c+"_"+b).html(k);$("#appraises-form").html("");wstMsg("评价成功")}else{if(l.status==-1){wstMsg("该订单不存在")}else{if(l.status==-2){wstMsg("亲，该商品已经评价过了~")}else{wstMsg("评价失败，请重试！")}}}})}function scrollToAppraises(d,b,g,a){$("#appraises-edit-container").show();var e=$("#appraises-edit-container").position();$(window).smoothScroll({position:e.top});$("#appraises-loading-icon").show();if(g==1){$.post(WST.U("WebApp/Goods/getAppraiseById"),{id:d},function(h){var j=WST.toJson(h);var k=Handlebars.compile($("#goods-appraises").text());Handlebars.registerHelper("list",function(o,m){var n="";for(var l=0;l<5;l++){if(l<o){n+='<img class="star" src="'+WST.ROOT+'/Apps/WebApp/View/default/images/1star.png">'}}return n});var i=k({info:j,rooturl:WST.ROOT,goodsId:goodsId});$("#appraises-form").html(i);$("#goodsName").html(b);$("#appraises-loading-icon").hide();j=i=k=null})}else{$("#goodsId").val(d);$("#goodsAttrId").val(a);var f=Handlebars.compile($("#goods-appraises").text());Handlebars.registerHelper("list",function(j){var k="";for(var h=0;h<5;h++){k+='<img class="star" src="'+WST.ROOT+'/Apps/WebApp/View/default/images/gray_star.png" onclick="javascript:clickStar('+j+","+h+');">'}return k});var c=f({rooturl:WST.ROOT});$("#appraises-form").html(c);$("#goodsName").html(b);$("#appraises-loading-icon").hide();c=f=null}}function getOrderList(){$("#loading-icon").show();var a={};a.pageSize=10;a.currPage=Number($("#currPage").val())+1;a.status=Number($("#status").val());$.post(WST.U("WebApp/Orders/getOrderList"),a,function(b){var f=WST.toJson(b);var h="";var g={"-7":"用户取消","-6":"用户取消","-5":"商家不同意拒收","-4":"商家确认拒收","-3":"用户拒收","-2":"未付款","-1":"用户取消","0":"未受理","1":"已受理","2":"打包中","3":"待收货","4":"已收货"};if(f&&f.root&&f.root.length>0){for(var d=0;d<f.root.length;d++){h+='<div class="orders" id="order'+f.root[d].orderId+'">';h+='<div class="am-g orders-top">';h+='<div class="am-u-sm-7 orders-shopname">'+f.root[d].shopName+"</div>";h+='<div class="am-u-sm-5 orders-top-right">';h+='<span class="orders-status">';if(status==4){h+="已收货"}else{if(status==5){h+="待评价"}else{h+=g[f.root[d].orderStatus]}}if(f.root[d].orderStatus==-7||f.root[d].orderStatus==-6||f.root[d].orderStatus==-4||f.root[d].orderStatus==-1){if(f.root[d].payType==1&&f.root[d].isPay==1){h+=(f.root[d].isRefund==1)?"(已退款)":"(未退款)"}}h+="</span>";h+="</div></div>";if(f.root[d].data&&f.root[d].data.length>0){for(var e=0;e<f.root[d].data.length;e++){h+='<a href="#details&'+f.root[d].orderId+'"><div class="am-g orders-middle">';h+='<div class="am-u-sm-2"><img src="'+WST.DEFAULT_IMG+'" data-echo="'+WST.ROOT+"/"+f.root[d].data[e].goodsThums+'" class="orders-goods-img"></div>';h+='<div class="am-u-sm-7"><span class="orders-goods-name">'+f.root[d].data[e].goodsName+"</span></div>";h+='<div class="am-u-sm-3 orders-goods-price-area">';h+='<span class="orders-goods-price">￥ '+f.root[d].data[e].goodsPrice+"</span>";h+='<span class="orders-goods-num">x'+f.root[d].data[e].goodsNums+"</span>";h+="</div></div></a>"}}h+='<div class="am-g orders-bottom"><div class="am-u-sm-12">';if(f.root[d].orderStatus==-2||f.root[d].orderStatus==0||f.root[d].orderStatus==1||f.root[d].orderStatus==2){h+='<span class="cancel-order" onclick="javascript:confirmCancelOrder('+f.root[d].orderId+","+f.root[d].orderStatus+');">取消订单</span>'}if(f.root[d].orderStatus==-2){h+='<span class="cancel-order" onclick="javascript:toPay('+f.root[d].orderId+');">付款</span>'}if(f.root[d].orderStatus==3){h+='<span class="cancel-order" onclick="javascript:toConfirmOrder('+f.root[d].orderId+",'receipt');\">确认收货</span>";h+='<span class="cancel-order" onclick="javascript:toConfirmOrder('+f.root[d].orderId+",'reject');\">拒收</span>"}if(f.root[d].orderStatus==4){h+='<a href="#appraises&'+f.root[d].orderId+'"><span class="cancel-order">'+((f.root[d].isAppraises==0)?"去评价":"查看评价")+"</span></a>"}if(f.root[d].noComplains==1&&(f.root[d].orderStatus==-5||f.root[d].orderStatus==-4||f.root[d].orderStatus==-3||f.root[d].orderStatus==4)){h+='<span class="cancel-order" onclick="javascript:goToComplains('+f.root[d].orderId+');">投诉</span>'}h+="</div>";var c=f.root[d].data?f.root[d].data.length:"";h+='<div class="am-u-sm-12" style="text-align:right;">共 '+c+' 件商品  实付：<span class="orders-totalmoney">￥'+f.root[d].totalMoney+"</span></div></div>";h+="</div></div>"}$("#currPage").val(f.currPage);$("#totalPage").val(f.totalPage);$("#orders-list").append(h);echo.init()}else{wstMsg("没有订单信息，快去下一个吧~")}$("#loading-icon").hide()})}var currPage=totalPage=0;var loading=false;$(document).ready(function(){initFooter("users");$("body").removeClass("am-with-fixed-header");getOrderList();$(".condition-li").click(function(){$("#loading-icon").show();$(this).addClass("condition-active").siblings("li.condition-li").removeClass("condition-active");var a=$(this).attr("status");$("#status").val(a);$("#currPage").val(0);$("#orders-list").html("");getOrderList()});$(window).scroll(function(){if(loading){return}if((5+$(window).scrollTop())>=($(document).height()-$(window).height())){currPage=Number($("#currPage").val());totalPage=Number($("#totalPage").val());if(totalPage>0&&currPage<totalPage){getOrderList()}}})});